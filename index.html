<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Defense Platform</title>
    
    <!-- Load React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5; 
            height: 100vh; 
            overflow: hidden;
        }
        
        #root { height: 100vh; width: 100vw; }
        
        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            background: #fafafa;
        }
        
        @media (max-width: 1100px) {
            .app-container { grid-template-columns: 260px 1fr 260px; }
        }
        
        @media (max-width: 900px) {
            .app-container { 
                grid-template-columns: 1fr; 
                grid-template-rows: 60px auto 1fr auto; 
            }
            .sidebar { display: none; }
        }

        .header {
            grid-column: 1 / -1;
            background: #1a1a2e;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 24px;
            justify-content: space-between;
            border-bottom: 3px solid #16213e;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: #e94560;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
        }
        
        .status-badge {
            background: #0f3460;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }
        
        .status-badge.ready { background: #16c79a; color: #1a1a2e; }
        .status-badge.pending { background: #f9a825; color: #1a1a2e; }

        .sidebar {
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar-right {
            border-right: none;
            border-left: 1px solid #e0e0e0;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }
        
        .toolbar {
            padding: 12px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            align-items: center;
            background: #fafafa;
        }
        
        .toolbar button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
        }
        
        .toolbar button:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        
        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .editor-content {
            width: 100%;
            height: 100%;
            padding: 40px;
            font-family: 'Georgia', serif;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            border: none;
            outline: none;
            resize: none;
            overflow-y: auto;
            background: white;
        }
        
        .editor-content:focus { outline: none; }
        
        .editor-placeholder {
            position: absolute;
            top: 40px;
            left: 40px;
            color: #999;
            font-style: italic;
            pointer-events: none;
            font-family: 'Georgia', serif;
            font-size: 16px;
            line-height: 1.8;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .card h3 {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .metric:last-child { border-bottom: none; }
        
        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
        }
        
        .metric-value.warning { color: #e94560; }
        .metric-value.success { color: #16c79a; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1a1a2e;
            font-size: 22px;
        }
        
        .modal-subtitle {
            margin: 8px 0 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .baseline-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .baseline-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .baseline-option:hover {
            border-color: #e94560;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.1);
        }
        
        .baseline-option.selected {
            border-color: #e94560;
            background: #fff5f7;
        }
        
        .baseline-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .baseline-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            color: #1a1a2e;
        }
        
        .baseline-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .input-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed #ddd;
        }
        
        .textarea-baseline {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            outline: none;
        }
        
        .textarea-baseline:focus {
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        .word-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        .word-count.valid {
            color: #16c79a;
            font-weight: 600;
        }

        .file-input-label {
            display: block;
            padding: 16px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
            font-size: 13px;
            color: #666;
        }
        
        .file-input-label:hover {
            border-color: #e94560;
            background: #fff5f7;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #e94560;
            color: white;
            width: 100%;
            margin-top: 12px;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #d63d56;
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
            width: 100%;
            margin-top: 12px;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .alert {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 12px 20px;
            background: white;
            border-left: 4px solid #e94560;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .alert.success { border-left-color: #16c79a; }
        .alert.warning { border-left-color: #f9a825; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Tokenizer
        const sentenceTokenizer = (text) => {
            if (!text) return [];
            return text.replace(/([.!?])\s+/g, "$1|").split("|").filter(s => s.trim().length > 0);
        };

        // Metrics calculations
        const calculateBurstiness = (sentences) => {
            if (!sentences || sentences.length < 2) return 0;
            const lengths = sentences.map(s => s.split(/\s+/).filter(w => w).length);
            const mean = lengths.reduce((a, b) => a + b, 0) / lengths.length;
            const variance = lengths.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / lengths.length;
            return Math.sqrt(variance);
        };

        const calculateDiversity = (text) => {
            if (!text) return 0;
            const words = text.toLowerCase().match(/\b[a-z]+\b/g) || [];
            if (words.length === 0) return 0;
            const unique = new Set(words);
            return unique.size / words.length;
        };

        // Baseline Modal Component
        const BaselineModal = ({ onComplete, onClose }) => {
            const [selectedOption, setSelectedOption] = useState(null);
            const [text, setText] = useState('');
            const [uploadedFile, setUploadedFile] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            
            const wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            const hasEnoughWords = wordCount >= 100;

            const analyzeContent = async (content, sourceType) => {
                setAnalyzing(true);
                const sentences = sentenceTokenizer(content);
                const burstiness = calculateBurstiness(sentences);
                const diversity = calculateDiversity(content);
                
                await new Promise(r => setTimeout(r, 800)); // Simulate processing
                
                const profile = {
                    createdAt: new Date().toISOString(),
                    type: sourceType,
                    wordCount: content.split(/\s+/).filter(w => w).length,
                    sentenceCount: sentences.length,
                    avgSentenceLength: sentences.length ? sentences.reduce((acc, s) => acc + s.split(' ').length, 0) / sentences.length : 0,
                    burstiness: burstiness,
                    lexicalDiversity: diversity,
                    confidence: Math.min(1, (content.split(/\s+/).filter(w => w).length) / 2000),
                    isGeneric: sourceType === 'generic'
                };
                
                localStorage.setItem('wdp_baseline', JSON.stringify(profile));
                setAnalyzing(false);
                onComplete(profile);
            };

            const handleTextSubmit = () => {
                if (hasEnoughWords) {
                    analyzeContent(text, 'text_input');
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setUploadedFile(file);
                    // Simulate file reading
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // In real app, would parse PDF/DOCX here
                        setText(event.target.result || `Content of ${file.name} would be extracted here...`);
                    };
                    reader.readAsText(file);
                }
            };

            const handleFileAnalyze = () => {
                if (text) {
                    analyzeContent(text, 'file_upload');
                }
            };

            const handleSkip = () => {
                const genericProfile = {
                    createdAt: new Date().toISOString(),
                    type: 'generic',
                    wordCount: 0,
                    sentenceCount: 0,
                    avgSentenceLength: 15,
                    burstiness: 0.35,
                    lexicalDiversity: 0.55,
                    confidence: 0.5,
                    isGeneric: true
                };
                localStorage.setItem('wdp_baseline', JSON.stringify(genericProfile));
                onComplete(genericProfile);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h2>Baseline Calibration</h2>
                            <p className="modal-subtitle">
                                Establish your authentic writing profile to detect voice drift and AI detection risks
                            </p>
                        </div>
                        
                        <div className="modal-body">
                            <div className="baseline-options">
                                {/* Option 1: Paste/Write */}
                                <div 
                                    className={`baseline-option ${selectedOption === 'text' ? 'selected' : ''}`}
                                    onClick={() => setSelectedOption('text')}
                                >
                                    <div className="baseline-icon">‚úèÔ∏è</div>
                                    <div className="baseline-title">Paste or Write Sample</div>
                                    <div className="baseline-desc">
                                        Paste existing essays or write directly (minimum 100 words)
                                    </div>
                                    
                                    {selectedOption === 'text' && (
                                        <div className="input-section">
                                            <textarea
                                                className="textarea-baseline"
                                                value={text}
                                                onChange={(e) => setText(e.target.value)}
                                                placeholder="Paste or type your writing sample here..."
                                                autoFocus
                                            />
                                            <div className={`word-count ${hasEnoughWords ? 'valid' : ''}`}>
                                                {wordCount} / 100 words {hasEnoughWords ? '‚úì' : 'minimum'}
                                            </div>
                                            <button 
                                                className="btn btn-primary"
                                                onClick={handleTextSubmit}
                                                disabled={!hasEnoughWords || analyzing}
                                            >
                                                {analyzing ? 'Analyzing...' : 'Create Profile'}
                                            </button>
                                        </div>
                                    )}
                                </div>

                                {/* Option 2: Upload File */}
                                <div 
                                    className={`baseline-option ${selectedOption === 'file' ? 'selected' : ''}`}
                                    onClick={() => setSelectedOption('file')}
                                >
                                    <div className="baseline-icon">üìÑ</div>
                                    <div className="baseline-title">Upload Your Sample</div>
                                    <div className="baseline-desc">
                                        Upload a document (DOCX, PDF, TXT, or MD)
                                    </div>
                                    
                                    {selectedOption === 'file' && (
                                        <div className="input-section">
                                            <input 
                                                type="file" 
                                                id="file-upload"
                                                style={{display: 'none'}}
                                                accept=".docx,.pdf,.txt,.md"
                                                onChange={handleFileUpload}
                                            />
                                            <label htmlFor="file-upload" className="file-input-label">
                                                {uploadedFile ? `Selected: ${uploadedFile.name}` : 'Click to select file'}
                                            </label>
                                            
                                            {uploadedFile && (
                                                <button 
                                                    className="btn btn-primary"
                                                    onClick={handleFileAnalyze}
                                                    disabled={analyzing}
                                                >
                                                    {analyzing ? 'Processing...' : 'Analyze File'}
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Option 3: Skip */}
                                <div 
                                    className="baseline-option"
                                    style={{borderStyle: 'dashed', opacity: 0.9}}
                                >
                                    <div className="baseline-icon">‚è≠Ô∏è</div>
                                    <div className="baseline-title">Skip for Later</div>
                                    <div className="baseline-desc">
                                        Use generic L2 baseline. You can calibrate your personal baseline anytime from Settings.
                                    </div>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={handleSkip}
                                        disabled={analyzing}
                                    >
                                        Continue with Generic Baseline
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [showBaseline, setShowBaseline] = useState(false);
            const [baseline, setBaseline] = useState(null);
            const [alerts, setAlerts] = useState([]);
            const [editorContent, setEditorContent] = useState('');
            
            // Load baseline on mount
            useEffect(() => {
                const saved = localStorage.getItem('wdp_baseline');
                if (!saved) {
                    setShowBaseline(true);
                } else {
                    setBaseline(JSON.parse(saved));
                }
            }, []);

            // Calculate metrics
            const sentences = sentenceTokenizer(editorContent);
            const burstiness = calculateBurstiness(sentences);
            const diversity = calculateDiversity(editorContent);
            const wordCount = editorContent.split(/\s+/).filter(w => w).length;

            const handleBaselineComplete = (profile) => {
                setBaseline(profile);
                setShowBaseline(false);
                addAlert('Baseline calibrated successfully!', 'success');
            };

            const addAlert = (message, type = 'info') => {
                const id = Date.now();
                setAlerts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setAlerts(prev => prev.filter(a => a.id !== id));
                }, 4000);
            };

            const handleEditorChange = (e) => {
                setEditorContent(e.target.value);
            };

            // Placeholder logic
            const showPlaceholder = editorContent.length === 0;

            return (
                <div className="app-container">
                    {showBaseline && (
                        <BaselineModal 
                            onComplete={handleBaselineComplete}
                        />
                    )}
                    
                    {/* Alerts */}
                    {alerts.map(alert => (
                        <div key={alert.id} className={`alert ${alert.type}`}>
                            {alert.message}
                        </div>
                    ))}

                    {/* Header */}
                    <header className="header">
                        <div className="logo">
                            <div className="logo-icon">W</div>
                            <div>
                                <div style={{fontWeight: 700}}>Writing Defense Platform</div>
                                <div style={{fontSize: '11px', opacity: 0.8}}>Phase 1 MVP</div>
                            </div>
                        </div>
                        
                        <div 
                            className={`status-badge ${baseline ? 'ready' : 'pending'}`}
                            onClick={() => setShowBaseline(true)}
                        >
                            {baseline ? `Baseline ${(baseline.confidence * 100).toFixed(0)}%` : '‚ö†Ô∏è No Baseline Set'}
                        </div>
                    </header>

                    {/* Left Sidebar */}
                    <aside className="sidebar sidebar-left">
                        <div className="card">
                            <h3>Baseline Profile</h3>
                            {baseline ? (
                                <div>
                                    <div className="metric">
                                        <span>Type</span>
                                        <span style={{fontWeight: 600, textTransform: 'capitalize'}}>
                                            {baseline.type === 'generic' ? 'Generic L2' : 'Personal'}
                                        </span>
                                    </div>
                                    <div className="metric">
                                        <span>Words Analyzed</span>
                                        <span style={{fontWeight: 600}}>
                                            {baseline.isGeneric ? 'N/A' : baseline.wordCount}
                                        </span>
                                    </div>
                                    <div className="metric">
                                        <span>Confidence</span>
                                        <span style={{fontWeight: 600, color: baseline.confidence > 0.8 ? '#16c79a' : '#f9a825'}}>
                                            {(baseline.confidence * 100).toFixed(0)}%
                                        </span>
                                    </div>
                                    <div className="metric">
                                        <span>Burstiness</span>
                                        <span style={{fontWeight: 600}}>{baseline.burstiness.toFixed(2)}</span>
                                    </div>
                                    <button 
                                        onClick={() => setShowBaseline(true)}
                                        style={{
                                            width: '100%', 
                                            marginTop: '12px', 
                                            padding: '8px', 
                                            background: '#f0f0f0', 
                                            border: 'none', 
                                            borderRadius: '4px', 
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: 500
                                        }}
                                    >
                                        Recalibrate Baseline
                                    </button>
                                </div>
                            ) : (
                                <p style={{fontSize: '13px', color: '#666', fontStyle: 'italic'}}>
                                    No baseline calibrated. Click "No Baseline Set" above to start.
                                </p>
                            )}
                        </div>

                        {baseline && (
                            <div className="card">
                                <h3>Voice Drift</h3>
                                <div className="metric">
                                    <span>Current Burstiness</span>
                                    <span className={`metric-value ${Math.abs(burstiness - baseline.burstiness) > 2 ? 'warning' : 'success'}`} style={{fontSize: '14px'}}>
                                        {burstiness.toFixed(2)}
                                    </span>
                                </div>
                                <div style={{fontSize: '12px', color: '#666', marginTop: '8px'}}>
                                    Œî {(burstiness - baseline.burstiness).toFixed(2)} from baseline
                                </div>
                            </div>
                        )}
                    </aside>

                    {/* Main Content */}
                    <main className="main-content">
                        <div className="toolbar">
                            <button onClick={() => document.execCommand('bold')}><b>B</b></button>
                            <button onClick={() => document.execCommand('italic')}><i>I</i></button>
                            <div style={{width: '1px', height: '20px', background: '#ddd', margin: '0 8px'}}></div>
                            <span style={{fontSize: '13px', color: '#666'}}>
                                {wordCount} words ‚Ä¢ {sentences.length} sentences
                            </span>
                        </div>
                        
                        <div className="editor-wrapper">
                            {showPlaceholder && (
                                <div className="editor-placeholder">
                                    Start writing here... The Shadow system will analyze your text in real-time as you type.
                                </div>
                            )}
                            <textarea
                                className="editor-content"
                                value={editorContent}
                                onChange={handleEditorChange}
                                spellCheck={false}
                            />
                        </div>
                    </main>

                    {/* Right Sidebar */}
                    <aside className="sidebar sidebar-right">
                        <div className="card">
                            <h3>Real-time Metrics</h3>
                            <div className="metric">
                                <span>Burstiness</span>
                                <span className="metric-value">{burstiness.toFixed(2)}</span>
                            </div>
                            <div className="metric">
                                <span>Lexical Diversity</span>
                                <span className="metric-value">{diversity.toFixed(2)}</span>
                            </div>
                            <div className="metric">
                                <span>Sentences</span>
                                <span className="metric-value">{sentences.length}</span>
                            </div>
                        </div>

                        <div className="card">
                            <h3>Shadow System</h3>
                            <div style={{padding: '12px', background: '#f5f5f5', borderRadius: '6px', marginTop: '8px'}}>
                                <div style={{fontSize: '12px', color: '#666', marginBottom: '8px'}}>AI Detection Risk</div>
                                <div style={{fontSize: '24px', fontWeight: '700', color: burstiness < 2 ? '#e94560' : '#16c79a'}}>
                                    {burstiness < 2 ? 'HIGH' : burstiness > 8 ? 'LOW' : 'MODERATE'}
                                </div>
                                <div style={{fontSize: '11px', color: '#999', marginTop: '4px'}}>
                                    Based on sentence variance
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
